name: Deploy to Azure

on:
  workflow_dispatch:
    inputs:
      ref:
        description: 'Branch to deploy'
        required: false
        default: 'main'

env:
  DOTNET_VERSION: '8.0.x'

jobs:
  terraform:
    runs-on: ubuntu-latest
    outputs:
      webapp_name: ${{ steps.terraform_output.outputs.webapp_name }}
      resource_group: ${{ steps.terraform_output.outputs.resource_group }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.inputs.ref || 'main' }}

    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: |
          {
            "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
            "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
            "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
            "tenantId": "${{ secrets.AZURE_TENANT_ID }}"
          }

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_wrapper: false

    - name: Terraform Init
      working-directory: ./terraform
      run: terraform init

    - name: Terraform Plan
      working-directory: ./terraform
      run: |
        if [ -n "${{ secrets.SQL_ADMIN_PASSWORD }}" ]; then
          terraform plan -var="app_name=${{ github.event.repository.name }}" -var="sql_admin_password=${{ secrets.SQL_ADMIN_PASSWORD }}" -out=tfplan
        else
          terraform plan -var="app_name=${{ github.event.repository.name }}" -out=tfplan
        fi

    - name: Terraform Apply with Retry
      working-directory: ./terraform
      run: |
        MAX_RETRIES=3
        RETRY_DELAY=30
        
        for i in $(seq 1 $MAX_RETRIES); do
          echo "Attempt $i of $MAX_RETRIES..."
          
          if terraform apply -auto-approve tfplan; then
            echo "Terraform apply succeeded on attempt $i"
            break
          else
            if [ $i -eq $MAX_RETRIES ]; then
              echo "Terraform apply failed after $MAX_RETRIES attempts"
              exit 1
            fi
            echo "Terraform apply failed, waiting $RETRY_DELAY seconds before retry..."
            sleep $RETRY_DELAY
            
            echo "Re-running terraform plan..."
            if [ -n "${{ secrets.SQL_ADMIN_PASSWORD }}" ]; then
              terraform plan -var="app_name=${{ github.event.repository.name }}" -var="sql_admin_password=${{ secrets.SQL_ADMIN_PASSWORD }}" -out=tfplan
            else
              terraform plan -var="app_name=${{ github.event.repository.name }}" -out=tfplan
            fi
          fi
        done

    - name: Get Terraform Outputs
      id: terraform_output
      working-directory: ./terraform
      run: |
        echo "webapp_name=$(terraform output -raw webapp_name)" >> $GITHUB_OUTPUT
        echo "resource_group=$(terraform output -raw resource_group)" >> $GITHUB_OUTPUT

  build:
    runs-on: ubuntu-latest
    needs: terraform
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.inputs.ref || 'main' }}

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Restore dependencies
      run: dotnet restore

    - name: Build
      run: dotnet build --configuration Release --no-restore

    - name: Publish
      run: dotnet publish --configuration Release --output ./publish --no-build

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: webapp-artifact
        path: ./publish

  deploy:
    runs-on: ubuntu-latest
    needs: [terraform, build]
    
    steps:
    - name: Download artifact
      uses: actions/download-artifact@v4
      with:
        name: webapp-artifact
        path: ./publish

    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: |
          {
            "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
            "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
            "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
            "tenantId": "${{ secrets.AZURE_TENANT_ID }}"
          }

    - name: Deploy to Azure Web App
      uses: azure/webapps-deploy@v3
      with:
        app-name: ${{ needs.terraform.outputs.webapp_name }}
        package: ./publish
