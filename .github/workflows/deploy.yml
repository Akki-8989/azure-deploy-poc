name: Deploy to Azure

on:
  workflow_dispatch:

env:
  DOTNET_VERSION: '8.0.x'
  TF_VERSION: '1.6.0'

jobs:
  terraform:
    runs-on: ubuntu-latest
    outputs:
      webapp_name: ${{ steps.tf_output.outputs.webapp_name }}
      webapp_url: ${{ steps.tf_output.outputs.webapp_url }}
      sql_connection_string: ${{ steps.tf_output.outputs.sql_connection_string }}
      sql_created: ${{ steps.tf_output.outputs.sql_created }}
      resource_group: ${{ steps.tf_output.outputs.resource_group }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}
        terraform_wrapper: false

    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: |
          {
            "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
            "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
            "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
            "tenantId": "${{ secrets.AZURE_TENANT_ID }}"
          }

    - name: Terraform Init
      working-directory: ./terraform
      run: terraform init

    - name: Terraform Plan & Apply
      working-directory: ./terraform
      run: |
        if [ -n "${{ secrets.SQL_ADMIN_PASSWORD }}" ]; then
          echo "SQL Admin Password provided - SQL Server will be created"
          terraform plan -out=tfplan \
            -var="subscription_id=${{ secrets.AZURE_SUBSCRIPTION_ID }}" \
            -var="app_name=${{ github.event.repository.name }}" \
            -var="sql_admin_password=${{ secrets.SQL_ADMIN_PASSWORD }}" \
            -var="create_sql_server=true"
        else
          echo "SQL Admin Password not provided - SQL Server will NOT be created"
          terraform plan -out=tfplan \
            -var="subscription_id=${{ secrets.AZURE_SUBSCRIPTION_ID }}" \
            -var="app_name=${{ github.event.repository.name }}" \
            -var="sql_admin_password=" \
            -var="create_sql_server=false"
        fi
        terraform apply -auto-approve tfplan

    - name: Get Terraform Outputs
      id: tf_output
      working-directory: ./terraform
      run: |
        echo "webapp_name=$(terraform output -raw webapp_name)" >> $GITHUB_OUTPUT
        echo "webapp_url=$(terraform output -raw webapp_url)" >> $GITHUB_OUTPUT
        echo "resource_group=$(terraform output -raw resource_group)" >> $GITHUB_OUTPUT
        SQL_CREATED=$(terraform output -raw sql_created 2>/dev/null || echo "false")
        echo "sql_created=$SQL_CREATED" >> $GITHUB_OUTPUT
        if [ "$SQL_CREATED" == "true" ]; then
          echo "sql_connection_string=$(terraform output -raw sql_connection_string)" >> $GITHUB_OUTPUT
        fi

  build:
    runs-on: ubuntu-latest
    needs: terraform

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Restore, Build & Publish
      run: |
        dotnet restore
        dotnet build --configuration Release --no-restore
        dotnet publish --configuration Release --output ./publish --no-build

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: webapp-artifact
        path: ./publish

  deploy:
    runs-on: ubuntu-latest
    needs: [terraform, build]

    steps:
    - name: Download artifact
      uses: actions/download-artifact@v4
      with:
        name: webapp-artifact
        path: ./publish

    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: |
          {
            "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
            "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
            "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
            "tenantId": "${{ secrets.AZURE_TENANT_ID }}"
          }

    - name: Deploy to Azure Web App
      uses: azure/webapps-deploy@v3
      with:
        app-name: ${{ needs.terraform.outputs.webapp_name }}
        package: ./publish

    - name: Update Connection String (if SQL created)
      if: needs.terraform.outputs.sql_created == 'true'
      run: |
        az webapp config connection-string set \
          --name ${{ needs.terraform.outputs.webapp_name }} \
          --resource-group ${{ needs.terraform.outputs.resource_group }} \
          --connection-string-type SQLAzure \
          --settings DefaultConnection="${{ needs.terraform.outputs.sql_connection_string }}"

    - name: Deployment Summary
      run: |
        echo "## Deployment Complete!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Web App URL:** ${{ needs.terraform.outputs.webapp_url }}" >> $GITHUB_STEP_SUMMARY
        if [ "${{ needs.terraform.outputs.sql_created }}" == "true" ]; then
          echo "**SQL Server:** Created" >> $GITHUB_STEP_SUMMARY
        else
          echo "**SQL Server:** Not created (no password provided)" >> $GITHUB_STEP_SUMMARY
        fi
