name: Terraform and Deploy

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - plan
          - apply
          - destroy
      sql_admin_password:
        description: 'SQL Admin Password'
        required: true
        type: string

env:
  TF_VAR_client_id: ${{ secrets.AZURE_CLIENT_ID }}
  TF_VAR_client_secret: ${{ secrets.AZURE_CLIENT_SECRET }}
  TF_VAR_tenant_id: ${{ secrets.AZURE_TENANT_ID }}
  TF_VAR_subscription_id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  TF_VAR_sql_admin_password: ${{ github.event.inputs.sql_admin_password }}
  ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
  ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

jobs:
  terraform:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Terraform Init
        working-directory: ./terraform
        run: terraform init

      - name: Import Existing Resources (if needed)
        if: github.event.inputs.action == 'apply'
        working-directory: ./terraform
        run: |
          SUBSCRIPTION_ID="${{ secrets.AZURE_SUBSCRIPTION_ID }}"
          RG_NAME="azure-deploy-rg"

          # Function to import resource if not in state
          import_if_missing() {
            RESOURCE_ADDR=$1
            RESOURCE_ID=$2

            if ! terraform state show "$RESOURCE_ADDR" > /dev/null 2>&1; then
              echo "Importing $RESOURCE_ADDR..."
              terraform import "$RESOURCE_ADDR" "$RESOURCE_ID" || echo "Import failed or resource doesn't exist in Azure"
            else
              echo "$RESOURCE_ADDR already in state"
            fi
          }

          # Import resources in order (dependencies first)
          import_if_missing "azurerm_resource_group.main" \
            "/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RG_NAME}"

          import_if_missing "azurerm_mssql_server.main" \
            "/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RG_NAME}/providers/Microsoft.Sql/servers/azure-deploy-sql"

          import_if_missing "azurerm_mssql_database.main" \
            "/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RG_NAME}/providers/Microsoft.Sql/servers/azure-deploy-sql/databases/azure-deploy-db"

          import_if_missing "azurerm_mssql_firewall_rule.allow_azure" \
            "/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RG_NAME}/providers/Microsoft.Sql/servers/azure-deploy-sql/firewallRules/AllowAzureServices"

          import_if_missing "azurerm_service_plan.main" \
            "/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RG_NAME}/providers/Microsoft.Web/serverFarms/azure-deploy-plan"

          import_if_missing "azurerm_windows_web_app.main" \
            "/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RG_NAME}/providers/Microsoft.Web/sites/azure-deploy-webapp"

      - name: Terraform Plan
        if: github.event.inputs.action == 'plan'
        working-directory: ./terraform
        run: terraform plan

      - name: Terraform Apply
        if: github.event.inputs.action == 'apply'
        working-directory: ./terraform
        run: terraform apply -auto-approve

      - name: Terraform Destroy
        if: github.event.inputs.action == 'destroy'
        working-directory: ./terraform
        run: terraform destroy -auto-approve

  deploy:
    runs-on: ubuntu-latest
    needs: terraform
    if: github.event.inputs.action == 'apply'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore dependencies
        run: dotnet restore

      - name: Build
        run: dotnet build --configuration Release --no-restore

      - name: Publish
        run: dotnet publish -c Release -o ./publish

      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v2
        with:
          app-name: 'azure-deploy-webapp'
          package: ./publish
